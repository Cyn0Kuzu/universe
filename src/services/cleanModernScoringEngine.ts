import firebase from 'firebase/compat/app';
import 'firebase/compat/firestore';
import { 
  ActionType, 
  EntityType, 
  ScoringMetadata, 
  ScoringResponse
} from '../types/index';
// Import services from index to avoid circular dependencies
// import { SafeNotificationCreator } from './SafeNotificationCreator';
// import { UserStatsManagementService } from './userStatsManagement';

interface SecurityResult {
  passed: boolean;
  reason?: string;
}

interface ActionConfig {
  user?: number;
  target?: number;
  club?: number;
  reversible?: boolean;
  cooldown?: number;
}

/**
 * üöÄ CLEAN ModernScoringEngine - Unified Notification Only
 * 
 * Bu versiyon sadece unified notification sistemi kullanƒ±r.
 * Hi√ß duplicate/legacy notification kodu yoktur.
 */
export class CleanModernScoringEngine {
  private db = firebase.firestore();
  // private userStatsService = UserStatsManagementService.getInstance();
  private cooldowns = new Map<string, number>();

  // üéØ Action Configurations - CLEAN & SIMPLE
  private readonly actionConfigs: Record<ActionType, ActionConfig> = {
    // üìÖ Event Interactions
    LIKE_EVENT: { user: 10, club: 15, reversible: true, cooldown: 30 },
    UNLIKE_EVENT: { user: -10, club: -15, reversible: false, cooldown: 0 },
    JOIN_EVENT: { user: 30, club: 20, reversible: true, cooldown: 60 },
    LEAVE_EVENT: { user: -30, club: -20, reversible: false, cooldown: 0 },
    COMMENT_EVENT: { user: 20, club: 10, reversible: true, cooldown: 180 },
    SHARE_EVENT: { user: 25, club: 12, reversible: true, cooldown: 300 },

    // üí¨ Comment Interactions  
    LIKE_COMMENT: { user: 5, target: 8, reversible: true, cooldown: 15 },
    UNLIKE_COMMENT: { user: -5, target: -8, reversible: false, cooldown: 0 },
    DELETE_COMMENT: { user: -20, club: -10, reversible: false, cooldown: 0 },

    // üèõÔ∏è Club Interactions
    FOLLOW_CLUB: { user: 15, club: 8, reversible: true, cooldown: 60 },
    UNFOLLOW_CLUB: { user: -15, club: -8, reversible: false, cooldown: 0 },
    JOIN_CLUB: { user: 50, club: 25, reversible: true, cooldown: 300 },
    LEAVE_CLUB: { user: -50, club: -25, reversible: false, cooldown: 0 },

    // üë• Member Management
    APPROVE_CLUB_MEMBER: { user: 25, target: 30, club: 15, reversible: true, cooldown: 0 },
    REJECT_CLUB_MEMBER: { user: 0, club: 0, reversible: false, cooldown: 0 },
    KICK_CLUB_MEMBER: { user: -25, target: -100, club: -15, reversible: false, cooldown: 0 },

    // üë§ User Following
    FOLLOW_USER: { user: 10, target: 15, reversible: true, cooldown: 45 },
    UNFOLLOW_USER: { user: -10, target: -15, reversible: false, cooldown: 0 },

    // üéì Academic Actions
    CREATE_EVENT: { user: 40, club: 25, reversible: false, cooldown: 1800 },
    UPDATE_EVENT: { user: 5, club: 3, reversible: false, cooldown: 300 },
    DELETE_EVENT: { user: -40, club: -25, reversible: false, cooldown: 0 },
    COMPLETE_PROFILE: { user: 100, reversible: false, cooldown: 0 },
    DAILY_LOGIN: { user: 5, reversible: false, cooldown: 86400 }
  };

  /**
   * üéØ MAIN ENTRY POINT - CLEAN & SIMPLE
   */
  async processAction(
    userId: string,
    action: ActionType,
    targetId?: string,
    targetType?: 'user' | 'event' | 'club',
    metadata?: ScoringMetadata
  ): Promise<ScoringResponse> {
    const callId = Math.random().toString(36).substring(2, 8);
    console.log(`üéØ [${callId}] CLEAN ModernScoringEngine.processAction START:`, { userId, action, targetId, targetType });

    try {
      // 1Ô∏è‚É£ G√ºvenlik kontrol√º
      const securityCheck = await this.performSecurityCheck(userId, action);
      if (!securityCheck.passed) {
        return { success: false, error: securityCheck.reason, userPointsAwarded: 0, activityId: '' };
      }

      // 2Ô∏è‚É£ Action config al
      const actionConfig = this.actionConfigs[action];
      if (!actionConfig) {
        return { success: false, error: `Bilinmeyen action: ${action}`, userPointsAwarded: 0, activityId: '' };
      }

      // 3Ô∏è‚É£ Puan hesapla
      const userPoints = Math.round(actionConfig.user || 0);
      const targetPoints = Math.round(actionConfig.target || 0);
      const clubPoints = Math.round(actionConfig.club || 0);

      console.log(`üí∞ [${callId}] Points: User=${userPoints}, Target=${targetPoints}, Club=${clubPoints}`);

      // 4Ô∏è‚É£ Cooldown kontrol√º
      if (actionConfig.cooldown && actionConfig.cooldown > 0) {
        const cooldownKey = `${userId}-${action}-${targetId}`;
        const lastAction = this.cooldowns.get(cooldownKey) || 0;
        const now = Date.now();
        
        if (now - lastAction < (actionConfig.cooldown || 0) * 1000) {
          return { success: false, error: '√áok sƒ±k i≈ülem yapƒ±yorsunuz', userPointsAwarded: 0, activityId: '' };
        }
        
        this.cooldowns.set(cooldownKey, now);
      }

      // 5Ô∏è‚É£ Safe metadata
      const safeMetadata: ScoringMetadata = {
        eventId: metadata?.eventId || targetId || undefined,
        eventTitle: metadata?.eventTitle || undefined,
        clubId: metadata?.clubId || (targetType === 'club' ? targetId : undefined),
        clubName: metadata?.clubName || undefined,
        action: action
      };

      // 6Ô∏è‚É£ Puanlarƒ± uygula
      await this.applyScores(userId, targetId, targetType, userPoints, targetPoints, clubPoints, safeMetadata);

      // 7Ô∏è‚É£ üÜï UNIFIED NOTIFICATIONS ONLY 
      await this.sendUnifiedNotifications(userId, targetId, targetType, action, userPoints, targetPoints, clubPoints, safeMetadata);

      // 8Ô∏è‚É£ Aktivite kaydƒ±
      const activityId = `activity_${Date.now()}_${Math.random().toString(36).substring(2, 8)}`;

      console.log(`‚úÖ [${callId}] CLEAN ModernScoringEngine SUCCESS`);
      return {
        success: true,
        userPointsAwarded: userPoints,
        targetPointsAwarded: targetPoints,
        clubPointsAwarded: clubPoints,
        activityId,
        message: `${action} ba≈üarƒ±yla i≈ülendi`
      };

    } catch (error) {
      console.error(`‚ùå [${callId}] CLEAN ModernScoringEngine ERROR:`, error);
      return {
        success: false,
        userPointsAwarded: 0,
        activityId: '',
        error: error instanceof Error ? error.message : 'Bilinmeyen hata'
      };
    }
  }

  /**
   * üÜï UNIFIED NOTIFICATION SYSTEM - TEK NOKTADA T√úM Bƒ∞LDƒ∞Rƒ∞MLER
   */
  private async sendUnifiedNotifications(
    userId: string,
    targetId: string | undefined,
    targetType: string | undefined,
    action: ActionType,
    userPoints: number,
    targetPoints: number,
    clubPoints: number,
    metadata: ScoringMetadata
  ): Promise<void> {
    try {
      // User'a bildirim (eƒüer puan varsa)
      if (userPoints !== 0) {
        await this.sendUnifiedUserNotification(userId, action, userPoints, metadata);
      }

      // Target user'a bildirim (eƒüer target puan varsa)
      if (targetPoints !== 0 && targetType === 'user' && targetId) {
        await this.sendUnifiedTargetNotification(targetId, userId, action, targetPoints, metadata);
      }

      // Club owner'a bildirim (eƒüer club puan varsa)
      if (clubPoints !== 0 && metadata.clubId) {
        await this.sendUnifiedClubNotification(metadata.clubId, userId, action, clubPoints, metadata);
      }

    } catch (error) {
      console.warn('Unified notification failed:', error);
    }
  }

  /**
   * üì± User'a unified bildirim g√∂nder
   */
  private async sendUnifiedUserNotification(
    userId: string,
    action: ActionType,
    points: number,
    metadata: ScoringMetadata
  ): Promise<void> {
    // Event/Club bilgilerini al
    let eventTitle = metadata.eventTitle || 'Etkinlik';
    let clubName = metadata.clubName || 'Kul√ºp';

    if (metadata.eventId) {
      try {
        const eventDoc = await this.db.collection('events').doc(metadata.eventId).get();
        if (eventDoc.exists) {
          eventTitle = eventDoc.data()?.title || eventTitle;
        }
      } catch (e) { /* ignore */ }
    }

    if (metadata.clubId && metadata.clubId !== 'unknown') {
      try {
        const clubDoc = await this.db.collection('users').doc(metadata.clubId).get();
        if (clubDoc.exists) {
          clubName = clubDoc.data()?.displayName || clubName;
        }
      } catch (e) { /* ignore */ }
    }

    // Notification content olu≈ütur
    const { type, title, message } = this.buildUserNotification(action, points, eventTitle, clubName);

    // Simple notification logging - actual notification service would be called here
    console.log(`üì± User notification: ${title} - ${message} (${points} points)`);
    
    // Store notification data for future implementation
    try {
      await this.db.collection('notifications').add({
        type: type,
        title: title,
        message: message,
        userId: userId,
        metadata: {
          points: Math.abs(points),
          action: action,
          ...(metadata.eventId && { eventId: metadata.eventId }),
          ...(metadata.clubId && { clubId: metadata.clubId })
        },
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error creating notification:', error);
    }

    console.log(`üì± Unified user notification sent: ${type} (${points} points)`);
  }

  /**
   * üéØ Target user'a unified bildirim g√∂nder
   */
  private async sendUnifiedTargetNotification(
    targetUserId: string,
    actorUserId: string,
    action: ActionType,
    points: number,
    metadata: ScoringMetadata
  ): Promise<void> {
    // Actor bilgilerini al
    let actorName = 'Kullanƒ±cƒ±';
    try {
      const actorDoc = await this.db.collection('users').doc(actorUserId).get();
      if (actorDoc.exists) {
        actorName = actorDoc.data()?.displayName || actorName;
      }
    } catch (e) { /* ignore */ }

    // Club bilgilerini al
    let clubName = metadata.clubName || 'Kul√ºp';
    if (metadata.clubId && metadata.clubId !== 'unknown') {
      try {
        const clubDoc = await this.db.collection('users').doc(metadata.clubId).get();
        if (clubDoc.exists) {
          clubName = clubDoc.data()?.displayName || clubName;
        }
      } catch (e) { /* ignore */ }
    }

    // Notification content olu≈ütur
    const { type, title, message } = this.buildTargetNotification(action, points, actorName, clubName);

    // Simple notification logging
    console.log(`üéØ Target notification: ${title} - ${message} (${points} points)`);
    
    // Store notification data
    try {
      await this.db.collection('notifications').add({
        type: type,
        title: title,
        message: message,
        userId: targetUserId,
        metadata: {
          points: Math.abs(points),
          action: action,
          actorName: actorName,
          ...(metadata.clubId && { clubId: metadata.clubId })
        },
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error creating target notification:', error);
    }

    console.log(`üéØ Unified target notification sent: ${type} (${points} points)`);
  }

  /**
   * üèõÔ∏è Club owner'a unified bildirim g√∂nder
   */
  private async sendUnifiedClubNotification(
    clubId: string,
    actorUserId: string,
    action: ActionType,
    points: number,
    metadata: ScoringMetadata
  ): Promise<void> {
    // Club owner'ƒ± bul
    let clubOwnerId = clubId;
    try {
      const clubDoc = await this.db.collection('users').doc(clubId).get();
      if (clubDoc.exists) {
        const clubData = clubDoc.data();
        clubOwnerId = clubData?.ownerId || clubData?.createdBy || clubId;
      }
    } catch (e) { /* ignore */ }

    // Actor bilgilerini al
    let actorName = 'Kullanƒ±cƒ±';
    try {
      const actorDoc = await this.db.collection('users').doc(actorUserId).get();
      if (actorDoc.exists) {
        actorName = actorDoc.data()?.displayName || actorName;
      }
    } catch (e) { /* ignore */ }

    // Event bilgilerini al
    let eventTitle = metadata.eventTitle || 'Etkinlik';
    if (metadata.eventId) {
      try {
        const eventDoc = await this.db.collection('events').doc(metadata.eventId).get();
        if (eventDoc.exists) {
          eventTitle = eventDoc.data()?.title || eventTitle;
        }
      } catch (e) { /* ignore */ }
    }

    // Notification content olu≈ütur
    const { type, title, message } = this.buildClubNotification(action, points, actorName, eventTitle);

    // Simple notification logging
    console.log(`üèõÔ∏è Club notification: ${title} - ${message} (${points} points)`);
    
    // Store notification data
    try {
      await this.db.collection('notifications').add({
        type: type,
        title: title,
        message: message,
        userId: clubOwnerId,
        metadata: {
          points: Math.abs(points),
          action: action,
          actorName: actorName,
          ...(metadata.eventId && { eventId: metadata.eventId })
        },
        read: false,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
    } catch (error) {
      console.error('Error creating club notification:', error);
    }

    console.log(`üèõÔ∏è Unified club notification sent: ${type} (${points} points)`);
  }

  /**
   * üìù User notification content builder
   */
  private buildUserNotification(action: ActionType, points: number, eventTitle: string, clubName: string) {
    const pointsText = Math.abs(points);
    const isPositive = points > 0;
    const emoji = isPositive ? 'üéâ' : '‚ö†Ô∏è';

    switch (action) {
      case 'LIKE_EVENT':
        return {
          type: 'event_like_points',
          title: '‚ù§Ô∏è Etkinlik Beƒüendin!',
          message: `${eventTitle} etkinliƒüini beƒüendin ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'UNLIKE_EVENT':
        return {
          type: 'event_unlike_points',
          title: 'üíî Beƒüeni Geri Alƒ±ndƒ±',
          message: `${eventTitle} etkinliƒüinden beƒüenini geri aldƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'JOIN_EVENT':
        return {
          type: 'event_joined_points',
          title: 'üìÖ Etkinliƒüe Katƒ±ldƒ±n!',
          message: `${eventTitle} etkinliƒüine katƒ±ldƒ±n ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'LEAVE_EVENT':
        return {
          type: 'event_left_points',
          title: 'üö™ Etkinlikten Ayrƒ±ldƒ±n',
          message: `${eventTitle} etkinliƒüinden ayrƒ±ldƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'COMMENT_EVENT':
        return {
          type: 'event_commented_points',
          title: 'üí¨ Yorum Yaptƒ±n!',
          message: `${eventTitle} etkinliƒüine yorum yaptƒ±n ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'JOIN_CLUB':
        return {
          type: 'club_join_points',
          title: 'üè† Kul√ºbe Katƒ±ldƒ±n!',
          message: `${clubName} kul√ºb√ºne katƒ±ldƒ±n ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'LEAVE_CLUB':
        return {
          type: 'club_left_points',
          title: 'üö™ Kul√ºpten Ayrƒ±ldƒ±n',
          message: `${clubName} kul√ºb√ºnden ayrƒ±ldƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'KICK_CLUB_MEMBER':
        return {
          type: 'club_kicked_points',
          title: '‚ùå Kul√ºpten √áƒ±karƒ±ldƒ±n',
          message: `${clubName} kul√ºb√ºnden √ßƒ±karƒ±ldƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'APPROVE_CLUB_MEMBER':
        return {
          type: 'club_membership_approved',
          title: '‚úÖ √úyelik Onaylandƒ±!',
          message: `${clubName} kul√ºb√ºne katƒ±lma isteƒüiniz onaylandƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'FOLLOW_CLUB':
        return {
          type: 'club_followed_points',
          title: 'üíñ Kul√ºb√º Takip Ettin!',
          message: `${clubName} kul√ºb√ºn√º takip ettin ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'UNFOLLOW_CLUB':
        return {
          type: 'club_unfollowed_points',
          title: 'üíî Takipten √áƒ±ktƒ±n',
          message: `${clubName} kul√ºb√ºnden takipten √ßƒ±ktƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'FOLLOW_USER':
        return {
          type: 'user_followed_points',
          title: 'üë• Kullanƒ±cƒ± Takip Ettin!',
          message: `Yeni bir kullanƒ±cƒ± takip ettin ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'UNFOLLOW_USER':
        return {
          type: 'user_unfollowed_points',
          title: 'üëã Takipten √áƒ±ktƒ±n',
          message: `Bir kullanƒ±cƒ±yƒ± takipten √ßƒ±kardƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'LIKE_COMMENT':
        return {
          type: 'comment_liked_points',
          title: 'üëç Yorum Beƒüendin!',
          message: `Bir yorumu beƒüendin ve ${pointsText} puan kazandƒ±n! ${emoji}`
        };

      case 'UNLIKE_COMMENT':
        return {
          type: 'comment_unliked_points',
          title: 'üëé Yorum Beƒüenisini Geri Aldƒ±n',
          message: `Yorum beƒüenini geri aldƒ±n ve ${pointsText} puan kaybettin ${emoji}`
        };

      case 'DELETE_COMMENT':
        return {
          type: 'comment_deleted_points',
          title: 'üóëÔ∏è Yorum Sildin',
          message: `Yorumunu sildin ve ${pointsText} puan kaybettin ${emoji}`
        };

      default:
        return {
          type: isPositive ? 'score_gain_points' : 'score_loss_points',
          title: isPositive ? 'üéØ Puan Kazandƒ±n!' : '‚ö†Ô∏è Puan Kaybettin',
          message: isPositive 
            ? `${this.getActionDescription(action)} - ${pointsText} puan kazandƒ±n! ${emoji}`
            : `${this.getActionDescription(action)} - ${pointsText} puan kaybettin ${emoji}`
        };
    }
  }

  /**
   * üéØ Target notification content builder
   */
  private buildTargetNotification(action: ActionType, points: number, actorName: string, clubName: string) {
    const pointsText = Math.abs(points);
    const isPositive = points > 0;
    const emoji = isPositive ? 'üéâ' : '‚ö†Ô∏è';

    switch (action) {
      case 'FOLLOW_USER':
        return {
          type: 'user_followed_points',
          title: 'üë• Yeni Takip√ßiniz Var!',
          message: `${actorName} sizi takip etti ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'UNFOLLOW_USER':
        return {
          type: 'user_unfollowed_points',
          title: 'üëã Takip√ßi Kaybƒ±',
          message: `${actorName} sizi takipten √ßƒ±kardƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'LIKE_COMMENT':
        return {
          type: 'comment_target_liked_points',
          title: 'üëç Yorumunuz Beƒüenildi!',
          message: `${actorName} yorumunuzu beƒüendi ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'UNLIKE_COMMENT':
        return {
          type: 'comment_target_unliked_points',
          title: 'üëé Yorum Beƒüenisi Geri Alƒ±ndƒ±',
          message: `${actorName} yorumunuzun beƒüenisini geri aldƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'APPROVE_CLUB_MEMBER':
        return {
          type: 'club_membership_approved',
          title: '‚úÖ √úyeliƒüiniz Onaylandƒ±!',
          message: `${clubName} kul√ºb√ºne katƒ±lma isteƒüiniz onaylandƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'KICK_CLUB_MEMBER':
        return {
          type: 'club_kicked_points',
          title: '‚ùå Kul√ºpten √áƒ±karƒ±ldƒ±nƒ±z',
          message: `${clubName} kul√ºb√ºnden √ßƒ±karƒ±ldƒ±nƒ±z ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      default:
        return {
          type: isPositive ? 'target_score_gain' : 'target_score_loss',
          title: isPositive ? 'üéØ Puan Kazandƒ±nƒ±z!' : '‚ö†Ô∏è Puan Kaybettiniz',
          message: isPositive 
            ? `${actorName} sayesinde ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
            : `${actorName} sebebiyle ${pointsText} puan kaybettiniz ${emoji}`
        };
    }
  }

  /**
   * üèõÔ∏è Club notification content builder
   */
  private buildClubNotification(action: ActionType, points: number, actorName: string, eventTitle: string) {
    const pointsText = Math.abs(points);
    const isPositive = points > 0;
    const emoji = isPositive ? 'üéâ' : '‚ö†Ô∏è';

    switch (action) {
      case 'LIKE_EVENT':
        return {
          type: 'event_like_points',
          title: '‚ù§Ô∏è Etkinliƒüiniz Beƒüenildi!',
          message: `${actorName} "${eventTitle}" etkinliƒüinizi beƒüendi ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'UNLIKE_EVENT':
        return {
          type: 'event_unlike_points',
          title: 'üíî Etkinlik Beƒüenisi Geri Alƒ±ndƒ±',
          message: `${actorName} "${eventTitle}" etkinliƒüinizin beƒüenisini geri aldƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'JOIN_EVENT':
        return {
          type: 'event_joined_points',
          title: 'üìÖ Etkinliƒüinize Katƒ±lƒ±m!',
          message: `${actorName} "${eventTitle}" etkinliƒüinize katƒ±ldƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'LEAVE_EVENT':
        return {
          type: 'event_left_points',
          title: 'üö™ Etkinlikten Ayrƒ±lma',
          message: `${actorName} "${eventTitle}" etkinliƒüinizden ayrƒ±ldƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'COMMENT_EVENT':
        return {
          type: 'event_commented_points',
          title: 'üí¨ Etkinliƒüinize Yorum!',
          message: `${actorName} "${eventTitle}" etkinliƒüinize yorum yaptƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'FOLLOW_CLUB':
        return {
          type: 'club_followed_points',
          title: 'üíñ Kul√ºb√ºn√ºz Takip Edildi!',
          message: `${actorName} kul√ºb√ºn√ºz√º takip etti ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'UNFOLLOW_CLUB':
        return {
          type: 'club_unfollowed_points',
          title: 'üíî Takipten √áƒ±kƒ±ldƒ±',
          message: `${actorName} kul√ºb√ºn√ºzden takipten √ßƒ±ktƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'JOIN_CLUB':
        return {
          type: 'club_member_joined_points',
          title: 'üè† Yeni √úye Katƒ±ldƒ±!',
          message: `${actorName} kul√ºb√ºn√ºze katƒ±ldƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      case 'LEAVE_CLUB':
        return {
          type: 'club_member_left_points',
          title: 'üö™ √úye Ayrƒ±ldƒ±',
          message: `${actorName} kul√ºb√ºn√ºzden ayrƒ±ldƒ± ve ${pointsText} puan kaybettiniz ${emoji}`
        };

      case 'APPROVE_CLUB_MEMBER':
        return {
          type: 'club_member_approved_points',
          title: '‚úÖ √úye Onayladƒ±nƒ±z!',
          message: `${actorName} kul√ºbe onaylandƒ± ve ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
        };

      default:
        return {
          type: isPositive ? 'club_score_gain_points' : 'club_score_loss_points',
          title: isPositive ? 'üéØ Kul√ºp Puan Kazandƒ±!' : '‚ö†Ô∏è Kul√ºp Puan Kaybetti',
          message: isPositive 
            ? `${actorName} sayesinde ${pointsText} puan kazandƒ±nƒ±z! ${emoji}`
            : `${actorName} sebebiyle ${pointsText} puan kaybettiniz ${emoji}`
        };
    }
  }

  /**
   * üí∞ Puanlarƒ± uygula
   */
  private async applyScores(
    userId: string,
    targetId: string | undefined,
    targetType: string | undefined,
    userPoints: number,
    targetPoints: number,
    clubPoints: number,
    metadata: ScoringMetadata
  ): Promise<void> {
    const batch = this.db.batch();

    // User puanƒ±
    if (userPoints !== 0) {
      const userRef = this.db.collection('users').doc(userId);
      batch.update(userRef, {
        totalPoints: firebase.firestore.FieldValue.increment(userPoints),
        lastUpdated: firebase.firestore.Timestamp.now()
      });
    }

    // Target user puanƒ±
    if (targetPoints !== 0 && targetType === 'user' && targetId) {
      const targetUserRef = this.db.collection('users').doc(targetId);
      batch.update(targetUserRef, {
        totalPoints: firebase.firestore.FieldValue.increment(targetPoints),
        lastUpdated: firebase.firestore.Timestamp.now()
      });
    }

    // Club puanƒ±
    if (clubPoints !== 0 && metadata.clubId) {
      const clubRef = this.db.collection('users').doc(metadata.clubId);
      batch.update(clubRef, {
        totalPoints: firebase.firestore.FieldValue.increment(clubPoints),
        lastUpdated: firebase.firestore.Timestamp.now()
      });
    }

    // Event puanƒ±
    if (targetPoints !== 0 && targetType === 'event' && targetId) {
      const eventRef = this.db.collection('events').doc(targetId);
      batch.update(eventRef, {
        score: firebase.firestore.FieldValue.increment(targetPoints),
        lastUpdated: firebase.firestore.Timestamp.now()
      });
    }

    await batch.commit();
    console.log('üí∞ Scores applied successfully');
  }

  /**
   * üõ°Ô∏è G√ºvenlik kontrol√º
   */
  private async performSecurityCheck(userId: string, action: ActionType): Promise<SecurityResult> {
    try {
      // User varlƒ±k kontrol√º
      const userDoc = await this.db.collection('users').doc(userId).get();
      if (!userDoc.exists) {
        return { passed: false, reason: 'Kullanƒ±cƒ± bulunamadƒ±' };
      }

      const userData = userDoc.data();
      
      // Banned kontrol√º
      if (userData?.isBanned || userData?.status === 'banned') {
        return { passed: false, reason: 'Yasaklƒ± kullanƒ±cƒ±' };
      }

      // Puan negatife d√º≈üme kontrol√º
      const currentPoints = userData?.totalPoints || 0;
      const actionConfig = this.actionConfigs[action];
      const userPointChange = actionConfig?.user || 0;
      
      if (currentPoints + userPointChange < 0) {
        return { passed: false, reason: 'Puan negatife d√º≈üemez' };
      }

      return { passed: true };

    } catch (error) {
      return { passed: false, reason: 'G√ºvenlik kontrol√º ba≈üarƒ±sƒ±z' };
    }
  }

  /**
   * üìã Action a√ßƒ±klamasƒ±
   */
  private getActionDescription(action: ActionType): string {
    const descriptions: Record<ActionType, string> = {
      LIKE_EVENT: 'Etkinlik beƒüeni',
      UNLIKE_EVENT: 'Etkinlik beƒüeni geri alma',
      JOIN_EVENT: 'Etkinliƒüe katƒ±lma',
      LEAVE_EVENT: 'Etkinlikten ayrƒ±lma',
      COMMENT_EVENT: 'Etkinlik yorumu',
      SHARE_EVENT: 'Etkinlik payla≈üƒ±m',
      LIKE_COMMENT: 'Yorum beƒüeni',
      UNLIKE_COMMENT: 'Yorum beƒüeni geri alma',
      DELETE_COMMENT: 'Yorum silme',
      FOLLOW_CLUB: 'Kul√ºp takip',
      UNFOLLOW_CLUB: 'Kul√ºp takip bƒ±rakma',
      JOIN_CLUB: 'Kul√ºbe katƒ±lma',
      LEAVE_CLUB: 'Kul√ºpten ayrƒ±lma',
      APPROVE_CLUB_MEMBER: '√úye onaylama',
      REJECT_CLUB_MEMBER: '√úye reddetme',
      KICK_CLUB_MEMBER: '√úye √ßƒ±karma',
      FOLLOW_USER: 'Kullanƒ±cƒ± takip',
      UNFOLLOW_USER: 'Kullanƒ±cƒ± takip bƒ±rakma',
      CREATE_EVENT: 'Etkinlik olu≈üturma',
      UPDATE_EVENT: 'Etkinlik g√ºncelleme',
      DELETE_EVENT: 'Etkinlik silme',
      COMPLETE_PROFILE: 'Profil tamamlama',
      DAILY_LOGIN: 'G√ºnl√ºk giri≈ü'
    };
    
    return descriptions[action] || action;
  }
}

// Export singleton instance
export const cleanModernScoringEngine = new CleanModernScoringEngine();
