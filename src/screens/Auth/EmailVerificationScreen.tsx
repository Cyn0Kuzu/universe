import React, { useState } from 'react';
import { View, StyleSheet, TouchableOpacity, Image, ActivityIndicator, Alert } from 'react-native';
import { Text, Button, useTheme } from 'react-native-paper';
import { StatusBar } from 'expo-status-bar';
import { SafeAreaView } from 'react-native-safe-area-context';
import { MaterialCommunityIcons } from '@expo/vector-icons';
import { NativeStackNavigationProp } from '@react-navigation/native-stack';
import { AuthStackParamList } from '../../navigation/AuthNavigator';
import { auth } from '../../firebase/config';
import { sendEmailVerification } from '../../firebase/auth';
import { useAuth } from '../../contexts/AuthContext';

// Custom theme type
interface CustomTheme {
  colors: {
    primary: string;
    accent: string;
    background: string;
    text: string;
    placeholder: string;
    cardBorder: string;
    lightGray: string;
    secondaryBlue: string;
    darkBlue: string;
  }
}

type EmailVerificationScreenProps = {
  navigation: NativeStackNavigationProp<AuthStackParamList, 'EmailVerification'>;
};

const EmailVerificationScreen: React.FC<EmailVerificationScreenProps> = ({ navigation }) => {
  const theme = useTheme() as CustomTheme;
  const { currentUser, checkVerification, signOut } = useAuth();
  const [sending, setSending] = useState<boolean>(false);
  const [checking, setChecking] = useState<boolean>(false);
  const [hasError, setHasError] = useState<boolean>(false);

  const navigateToWelcome = async () => {
    try {
      console.log('üè† Navigating based on verification status...');
      
      // Check current verification status first
      const isVerified = await checkVerification();
      
      if (isVerified) {
        console.log('‚úÖ Email verified, staying logged in');
        // Email verified, AuthNavigator will handle navigation to AppNavigator
        return;
      } else {
        console.log('‚ö†Ô∏è Email not verified, initiating logout sequence...');
        
        // Step 1: Use AuthContext signOut for proper cleanup
        await signOut();
        console.log('‚úÖ AuthContext signOut completed');
        
        // Step 2: Force immediate navigation reset
        // This will override AuthNavigator's automatic handling
        setTimeout(() => {
          try {
            console.log('üîÑ Force resetting navigation to Welcome');
            navigation.reset({
              index: 0,
              routes: [{ name: 'Welcome' }],
            });
          } catch (navError) {
            console.error('‚ùå Navigation reset failed:', navError);
            // Last resort: navigate to Welcome
            navigation.navigate('Welcome');
          }
        }, 50); // Small delay to ensure signOut completes
      }
    } catch (error) {
      console.error('‚ùå Navigation error:', error);
      // Emergency fallback: immediate force navigation
      try {
        navigation.reset({
          index: 0,
          routes: [{ name: 'Welcome' }],
        });
        console.log('üö® Emergency navigation to Welcome');
      } catch (emergencyError) {
        console.error('‚ùå Emergency navigation also failed:', emergencyError);
      }
    }
  };

  const navigateToLogin = async () => {
    try {
      // Use AuthContext signOut to properly clear state and navigate
      await signOut();
    } catch (error) {
      console.error('Error signing out:', error);
      // Fallback: navigate to welcome using auth.signOut
      await navigateToWelcome();
    }
  };

  const handleSendVerification = async () => {
    if (!currentUser) {
      // No user is logged in, redirect to login with message
      Alert.alert(
        "Hesap Doƒürulama",
        "G√ºvenlik nedeniyle oturumunuz sonlandƒ±rƒ±ldƒ±. Email adresinizi doƒüruladƒ±ktan sonra normal ≈üekilde giri≈ü yapabilirsiniz.",
        [
          { 
            text: "Ana Sayfaya D√∂n", 
            onPress: async () => await navigateToWelcome()
          }
        ]
      );
      return;
    }

    setSending(true);
    setHasError(false);
    
    try {
      await sendEmailVerification();
      Alert.alert(
        "E-posta G√∂nderildi", 
        `Doƒürulama e-postasƒ± ${currentUser.email} adresine g√∂nderildi. L√ºtfen gelen kutunuzu kontrol edin ve baƒülantƒ±ya tƒ±klayƒ±n.`
      );
    } catch (error) {
      setHasError(true);
      const errorMsg = error instanceof Error ? error.message : 'Doƒürulama e-postasƒ± g√∂nderilemedi.';
      Alert.alert("Hata", errorMsg);
    } finally {
      setSending(false);
    }
  };

  const handleCheckVerification = async () => {
    if (!currentUser) {
      Alert.alert(
        "Hesap Doƒürulama",
        "G√ºvenlik nedeniyle oturumunuz sonlandƒ±rƒ±ldƒ±. Email adresinizi doƒüruladƒ±ktan sonra normal ≈üekilde giri≈ü yapabilirsiniz.",
        [
          { 
            text: "Ana Sayfaya D√∂n", 
            onPress: async () => await navigateToWelcome()
          }
        ]
      );
      return;
    }
    
    setChecking(true);
    
    try {
      console.log('üîÑ User initiated verification check...');
      
      // Force reload the current user from Firebase
      await currentUser.reload();
      console.log('‚úÖ User reloaded, checking verification...');
      
      // Get fresh user instance after reload
      const freshUser = auth.currentUser;
      if (!freshUser) {
        console.log('‚ùå No current user found after reload');
        Alert.alert(
          "Oturum S√ºresi Doldu",
          "G√ºvenlik nedeniyle oturumunuz sonlandƒ±rƒ±ldƒ±. L√ºtfen tekrar giri≈ü yapƒ±n.",
          [
            { text: "Giri≈ü Yap", onPress: navigateToLogin }
          ]
        );
        return;
      }
      
      console.log('üìß Current verification status:', freshUser.emailVerified);
      
      // Check directly from Firebase user instead of using AuthContext to avoid loops
      if (freshUser.emailVerified) {
        Alert.alert(
          "Email Doƒürulandƒ±! üéâ",
          "E-posta adresiniz ba≈üarƒ±yla doƒürulandƒ±. Artƒ±k giri≈ü yapabilirsiniz.",
          [
            { 
              text: "Giri≈ü Yap", 
              onPress: () => {
                console.log('‚úÖ Email verified, redirecting to login...');
                navigateToLogin();
              }
            }
          ]
        );
      } else {
        Alert.alert(
          "Doƒürulama Bekleniyor ‚è≥",
          "E-posta adresiniz hen√ºz doƒürulanmamƒ±≈ü.\n\n1. E-posta kutunuzu kontrol edin\n2. Spam/gereksiz klas√∂r√ºn√º kontrol edin\n3. Doƒürulama baƒülantƒ±sƒ±na tƒ±klayƒ±n\n4. Bu butona tekrar basƒ±n",
          [
            { text: "Yeni E-posta G√∂nder", onPress: handleSendVerification },
            { text: "Tamam", style: "cancel" }
          ]
        );
      }
    } catch (error) {
      console.error('‚ùå Error checking verification:', error);
      const errorMsg = error instanceof Error ? error.message : 'Doƒürulama durumu kontrol edilemedi.';
      
      // Handle session expired specifically
      if (errorMsg.includes('session') || errorMsg.includes('expired') || errorMsg.includes('auth')) {
        Alert.alert(
          "Oturum Hatasƒ±",
          "Oturumunuzda bir sorun olu≈ütu. L√ºtfen tekrar giri≈ü yapƒ±n.",
          [
            { text: "Giri≈ü Yap", onPress: navigateToLogin }
          ]
        );
      } else {
        Alert.alert(
          "Kontrol Hatasƒ±",
          "Doƒürulama durumu kontrol edilirken bir hata olu≈ütu. L√ºtfen tekrar deneyin."
        );
      }
    } finally {
      setChecking(false);
    }
  };

  const handleLogout = async () => {
    try {
      console.log('üö™ Starting forced logout from EmailVerificationScreen...');
      
      // Step 1: Use AuthContext signOut for proper cleanup
      await signOut();
      console.log('‚úÖ AuthContext signOut completed');
      
      // Step 2: Force immediate navigation with aggressive reset
      // This bypasses AuthNavigator's conditional rendering
      setTimeout(() => {
        try {
          console.log('üîÑ Executing forced navigation reset...');
          
          // Reset the entire navigation stack to Welcome
          navigation.getParent()?.reset({
            index: 0,
            routes: [{ name: 'Welcome' }],
          });
          
          console.log('‚úÖ Navigation reset to Welcome completed');
        } catch (navError) {
          console.error('‚ùå Navigation reset failed, trying alternative:', navError);
          
          // Alternative: try navigate with replace
          try {
            navigation.replace('Welcome');
            console.log('‚úÖ Navigate replace to Welcome completed');
          } catch (replaceError) {
            console.error('‚ùå All navigation methods failed:', replaceError);
          }
        }
      }, 100); // Longer delay to ensure signOut state update
      
    } catch (error) {
      console.error('‚ùå Logout error:', error);
      
      // Emergency fallback: Force navigation even if signOut fails
      try {
        navigation.getParent()?.reset({
          index: 0,
          routes: [{ name: 'Welcome' }],
        });
        console.log('üö® Emergency navigation to Welcome');
      } catch (emergencyError) {
        console.error('‚ùå Emergency navigation also failed:', emergencyError);
      }
    }
  };

  return (
    <SafeAreaView style={[styles.container, { backgroundColor: theme.colors.background }]}>
      <StatusBar style="dark" />
      
      <View style={styles.content}>
        <MaterialCommunityIcons 
          name="email-check" 
          size={100} 
          color={theme.colors.primary} 
          style={styles.icon}
        />
        
        <Text style={[styles.title, { color: theme.colors.text }]}>E-posta Doƒürulamasƒ± Gerekli</Text>
        
        <Text style={[styles.description, { color: theme.colors.placeholder }]}>
          {currentUser ? (
            <>
              Hesabƒ±nƒ±za eri≈ümek i√ßin l√ºtfen e-posta adresinizi doƒürulayƒ±n. 
              {'\n\n'}{currentUser.email} adresine g√∂nderilen doƒürulama baƒülantƒ±sƒ±nƒ± kontrol edin ve tƒ±klayƒ±n.
            </>
          ) : (
            <>
              Kayƒ±t i≈üleminiz tamamlandƒ±! üéâ
              {'\n\n'}G√ºvenlik nedeniyle oturumunuz sonlandƒ±rƒ±ldƒ±. 
              E-posta kutunuzu kontrol edin, doƒürulama baƒülantƒ±sƒ±na tƒ±klayƒ±n ve ardƒ±ndan normal ≈üekilde giri≈ü yapƒ±n.
            </>
          )}
        </Text>
        
        <View style={styles.buttonGroup}>
          {currentUser ? (
            <>
              <Button
                mode="contained"
                onPress={handleSendVerification}
                style={[styles.button, { backgroundColor: theme.colors.primary }]}
                loading={sending}
                disabled={sending}
              >
                Doƒürulama E-postasƒ±nƒ± Yeniden G√∂nder
              </Button>
              
              <Button
                mode="outlined"
                onPress={handleCheckVerification}
                style={[styles.button, { borderColor: theme.colors.primary, marginTop: 12 }]}
                loading={checking}
                disabled={checking}
              >
                Doƒürulama Durumunu Kontrol Et
              </Button>
              
              <TouchableOpacity 
                style={styles.backLink}
                onPress={handleLogout}
              >
                <Text style={{ color: theme.colors.secondaryBlue }}>
                  Ana sayfaya d√∂n
                </Text>
              </TouchableOpacity>
            </>
          ) : (
            <Button
              mode="contained"
              onPress={async () => await navigateToWelcome()}
              style={[styles.button, { backgroundColor: theme.colors.primary }]}
            >
              Ana Sayfaya D√∂n
            </Button>
          )}
        </View>
        
        <View style={styles.helpContainer}>
          <Text style={[styles.helpText, { color: theme.colors.placeholder }]}>
            E-posta almadƒ±nƒ±z mƒ±? Spam klas√∂r√ºn√ºz√º kontrol edin veya 
            yukarƒ±daki butonu kullanarak yeniden g√∂ndermeyi deneyin.
          </Text>
        </View>
      </View>
    </SafeAreaView>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
  },
  content: {
    flex: 1,
    padding: 24,
    justifyContent: 'center',
    alignItems: 'center',
  },
  icon: {
    marginBottom: 24,
  },
  title: {
    fontSize: 24,
    fontWeight: 'bold',
    textAlign: 'center',
    marginBottom: 16,
  },
  description: {
    fontSize: 16,
    textAlign: 'center',
    lineHeight: 24,
    marginBottom: 36,
  },
  buttonGroup: {
    width: '100%',
    alignItems: 'center',
  },
  button: {
    width: '100%',
    paddingVertical: 8,
  },
  backLink: {
    marginTop: 24,
    padding: 8,
  },
  helpContainer: {
    marginTop: 48,
    paddingHorizontal: 16,
  },
  helpText: {
    fontSize: 14,
    textAlign: 'center',
    lineHeight: 20,
  }
});

export default EmailVerificationScreen;
